/**
 * generate-build-info.js
 *
 * Generates src/utils/buildInfo.ts with auto-incremented build number
 * and build timestamp. Run BEFORE `expo export` so the values are bundled.
 *
 * Build number = git commit count on current branch.
 * Build stamp = ISO timestamp of the build.
 */

const { execFileSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// Git commit count as build number
let buildNumber;
try {
  buildNumber = parseInt(execFileSync('git', ['rev-list', '--count', 'HEAD'], { encoding: 'utf8' }).trim(), 10);
} catch {
  buildNumber = 0;
}

// Short commit hash
let commitHash;
try {
  commitHash = execFileSync('git', ['rev-parse', '--short', 'HEAD'], { encoding: 'utf8' }).trim();
} catch {
  commitHash = 'unknown';
}

const buildStamp = new Date().toISOString();

// Read version from app.json
const appJsonPath = path.join(__dirname, '..', 'app.json');
const appJson = JSON.parse(fs.readFileSync(appJsonPath, 'utf8'));
const version = appJson.expo.version;

const content = `// Auto-generated by scripts/generate-build-info.js â€” do not edit manually
export const BUILD_NUMBER = ${buildNumber};
export const BUILD_STAMP = '${buildStamp}';
export const BUILD_HASH = '${commitHash}';
export const APP_VERSION = '${version}';
`;

const outPath = path.join(__dirname, '..', 'src', 'utils', 'buildInfo.ts');
fs.writeFileSync(outPath, content, 'utf8');
console.log(`[build-info] Version ${version}, Build #${buildNumber} (${commitHash}), ${buildStamp}`);
